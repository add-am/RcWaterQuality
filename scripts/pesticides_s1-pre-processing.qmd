---
title: "Pesticides Data Analysis"
subtitle: "A Healthy Waters Partnership Analysis"
description: "This script performs the simple preprocessings steps required for data to be input into DETSI's PRM tool. The output of this is used in the Dry Tropics Technical Report."
author: "Adam Shand"
format: html
params:
  script_fyear: 2024 
---

# Introduction

The purpose of this script is to perform the preprocsessing steps required for the data to be input into DETSI's Pesticide Risk Metric tool. The preprocessing is relatively straight forward and is easily understood.

# Script Set Up

This script requires multiple core spatial packages, each of which is loaded below. Key variables and paths are also created.

```{r}
#| label: load packages

#use pacman function to load and install (if required) all other packages
pacman::p_load(tidyverse, glue, here, janitor, readxl, busdater)

#install/load the custom RcTools package
#pak::pak("add-am/RcTools")
library(RcTools)

params <- get_quarto_params()

#return each param as its own object
script_fyear <- params$script_fyear

#load in the custom function used to create the read and write folders for the script
source("functions/setup_helper.R")

#get the required paths
paths <- setup_helper(script_fyear)
data_path <- paths[[1]]
output_path <- paths[[2]]

#turn off scientific notation
options(scipen = 999)

```

# Load, Edit, Save

Below we load the data, perform the required edits, and save the data.

```{r}
#| label: load, edit, and save main data

#read in the data
data <- read_csv(glue("{data_path}/pesticide_concentrations.csv"))

#change the column types of the date and value columns
data1 <- data |> 
  mutate(`Date Time` = dmy_hm(`Date Time`),
         Value = as.numeric(Value))

#remove rows that have "weird" operators and unite the operator with the value
data2 <- data1 |> 
  filter(Operator == "<"| is.na(Operator)) |> 
  unite(Value, c(Operator, Value), sep = "", na.rm = T)

#select our columns of interest and pivot the data wider
data3 <- data2 |> 
  select("Site Name", "Date Time", "Analyte", "Value") |> 
  pivot_wider(names_from = "Analyte", values_from = "Value")

#rename some columns
data4 <- data3 |> 
  rename(Site.Name = "Site Name", Date = "Date Time", MCPA = "MCPA (Monochlorophenoxyacetic acid)")

#remove data pre 2017
data5 <- data4 |> 
  filter(Date > "2017-01-01 00:00:00")

#save the data to the processed folder
write_csv(data5, glue("{output_path}/pesticides_for_prm.csv"))

```

Then we also extract a first flush spreadsheet. We are working on the understanding that first flush in this case is just the first sample for the financial year - given that the pesticides team does not usually sample year round.

```{r}
#| label: extract first flush

#establish a financial year and select only our relevant columns
first_flush <- data5 |> 
  mutate(Fyear = get_fy(Date)) |> 
  select(Site.Name, Fyear, Date)

#group by site and fyear, order by date, and extract the first of each group
first_flush <- first_flush |> 
  group_by(Site.Name, Fyear) |> 
  arrange(Date) |> 
  filter(row_number() == 1) |> 
  ungroup()

#drop the fyear column and rename our date column
first_flush <- first_flush |> 
  select(Site.Name, Date) |> 
  rename(First.Flush.Date = Date)

#save the data to the processesed folder
write_csv(first_flush, glue("{output_path}/first_flush_for_prm.csv"))

```

```{r}


```

All done.

The saved datasets are now ready to be input into DETSI's online PRM tool.
