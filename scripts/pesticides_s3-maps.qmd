---
title: "Pesticides Mapping"
subtitle: "A Healthy Waters Partnership Analysis"
description: "This script creates a map of all pesticide sampling locations in the Dry Tropics region. The output of this is used in the Dry Tropics Technical Report."
author: "Adam Shand"
format: html
params:
  script_crs: "EPSG:7844"
  script_fyear: 2024 
---

# Introduction

The purpose of this script is to create maps identifying the sampling site locations for the freshwater pesticides index. These maps are used in the body of the methods document, and in the appendix of the technical report.

# Script Set Up

This script requires multiple core spatial packages, each of which is loaded below. Key variables and paths are also created.

```{r}
#| label: load packages

#use pacman function to load and install (if required) all other packages
pacman::p_load(tidyverse, glue, here, janitor, sf, tmap, readxl, grid)

#install/load the custom RcTools package
#pak::pak("add-am/RcTools")
library(RcTools)

params <- get_quarto_params()

#return each param as its own object
script_crs <- params$script_crs
script_fyear <- params$script_fyear

#load in the custom function used to create the read and write folders for the script
source("functions/setup_helper.R")

#get the required paths
paths <- setup_helper(script_fyear)
data_path <- paths[[1]]
output_path <- paths[[2]]

#manually change data path for now
data_path <- "data/pesticides/raw/"

```

# Load Data

## Spatial Data

A custom function build (or reloads) the n3_region dataset.

``` {r}
#| label: Load data

#if the data is on file, load it, otherwise built it and save it for next time
if (file.exists(here("data/n3_region.gpkg"))){
  n3_region <- st_read(here("data/n3_region.gpkg"))
} else {
  n3_region <- build_n3_region()
  st_write(n3_region, here("data/n3_region.gpkg"))
}

```

```{r}
#| label: load in all data

#reduce the n3_region file down to only the components we need
dt_region <- n3_region |> 
  name_cleaning() |> 
  filter(Region == "Dry Tropics",
         Environment != "Marine") |> 
  group_by(Region, BasinOrZone, SubBasinOrSubZone) |> 
  summarise(geom = st_union(geom)) |> 
  ungroup() |> st_cast() |> st_make_valid()

#read in the metadata and extra site coordinate information
sites <- read_excel(glue("{data_path}/pesticides_metadata.xlsx"),
                            sheet = "Current_Sites", na = c("", "NA", "NULL", "null")) |> 
  select(BasinOrZone, SubBasinOrSubZone, WatercourseOrGeographicArea, Code, Lat, Long) |> 
  st_as_sf(coords = c("Long", "Lat"), crs = script_crs) |> 
  name_cleaning()

```

# Create Map

Now we can put everything together. We will loop over the Ross and Black to make individual maps.

```{r}
#| label: create region maps

for (i in unique(dt_region$BasinOrZone)){
  
  #filter sites and rename column
  filtered_sites <- sites |> 
    filter(BasinOrZone == i) |> 
    rename("Sub Basin: Reported" = SubBasinOrSubZone)
  
  #define focus area and rename column
  focus_area <- dt_region |> 
    filter(BasinOrZone == i) |> 
    rename("Sub Basin: All" = SubBasinOrSubZone)

  #create the base water layer for the specific basin
  water_layer <- maps_water_layer(i, WaterAreas = TRUE, WaterLakes = TRUE, StreamOrder = 2)

  #create the background layer using the broader dry tropics backdrop
  inset_objects <- maps_inset_layer(filtered_sites, focus_area, 1.1)

  #create the main map
  map <- tm_shape(qld) +
    tm_polygons(fill = "grey80", col = "black") +
    tm_shape(dt_region) +
    tm_polygons(fill = "grey90", col = "black") +
    tm_shape(focus_area, is.main = T) +
    tm_polygons(
      fill = "Sub Basin: All",
      fill.scale = tm_scale_categorical(values = "brewer.pastel1"),
      fill_alpha = 0.5, 
      col = "black") +
    water_layer +
    tm_shape(filtered_sites) +
    tm_symbols(
      size = 0.6,
      fill = "Sub Basin: Reported",
      fill.scale = tm_scale_categorical(values = "brewer.set1"),
      col = "black", 
      lwd = 2, 
      shape = 21) +
    tm_text(
      "Code", 
      size = 0.9,
      options = opt_tm_text(shadow = TRUE, point.label = TRUE)) +
    tm_layout(
      legend.bg.color = "white", 
      legend.position = c("left", "bottom"),
      asp = 1)

  #save map
  tmap_save(
    map, 
    glue("{output_path}/{i}_Pesticides.png"), 
     insets_tm = inset_objects[[1]], 
    insets_vp = inset_objects[[2]])
  
}

```

```{r}


```
