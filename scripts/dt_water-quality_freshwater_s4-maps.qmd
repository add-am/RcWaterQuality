---
title: "Freshwater Water Quality Exploratory Data Analysis"
subtitle: "A Healthy Waters Partnership Analysis"
description: "Script 4 in a series of script designed to analyse, score, and present freshwater water quality in the Dry Tropics region. The output of this is used in the Dry Tropics Technical Report."
author: "Adam Shand"
format: html
params:
  project_crs: "EPSG:7844"
  target_fyear: 2024 
---

# Introduction

The purpose of this script is to create maps identifying the sampling site locations for the freshwater water quality index.

These maps are used in the body of the methods document, and in the appendix of the technical report.

# Script Set Up

This script requires multiple core spatial packages, each of which is loaded below. Key variables and paths are also created.

```{r}
#| label: load packages

#use pacman function to load and install (if required) all other packages
pacman::p_load(tidyverse, glue, here, sf, tmap, janitor, readxl, grid, RColorBrewer)

if (interactive()) {
params <- rmarkdown::yaml_front_matter(rstudioapi::getSourceEditorContext()$path)$params
}

#load in the custom function used to create the read and write folders for the script
source(here("functions/script_setup.R"))

#run the function to create the folders and paths
script_setup()

#read in the custom function to clean column names into our specific style
source(here("functions/name_cleaning.R"))

#turn off spherical geometry
sf_use_s2(F)

#determine if we want the dataset to be the one with removed sites, or the original
removed <- params$sites_removed

#set the project crs
proj_crs <- params$project_crs

```

# Load Data

Now the script is set up we need to load in all of the required datasets. Spatial data for the northern three regions should be readily available in the repo, the dataset is created by the n3_region-builder.qmd script in the repo that should be the first script run for new users. If the dataset is not available refer back to the README document in the GitHub repo. The other parts of spatial data here should go off without a hitch if the region-builder script has been run.

```{r}
#| label: load in all data
#| output: false

#read in the northern three spatial files and reduce down to only the components we need
dt_region <- n3_region |> 
  filter(Region == "Dry Tropics",
         Environment != "Marine") |> 
  group_by(BasinOrZone, SubBasinOrSubZone) |> 
  summarise(geom = st_union(geom)) |> 
  ungroup() |> st_cast() |> st_make_valid()

#read in site coords and convert to a simple feature object
sites <- read_excel(path = glue("{data_path}/dt_wq_freshwater_metadata.xlsx"), sheet = "Current_Sites") |> 
  select(BasinOrZone, SubBasinOrSubZone, WatercourseOrGeographicArea, Code, Lat, Long) |> 
  st_as_sf(coords = c("Long", "Lat"), crs = proj_crs)

st_write(sites, "fw_sites.gpkg")

```

# Create Map

Now we can put everything together. We will loop over the Ross and Black to make individual maps.

```{r}
#| label: create region maps

#load in custom function to create the water related layers of the map
source(here("functions/maps_water_layer.R"))

#load in custom function to create the inset map
source(here("functions/maps_inset_layer.R"))

#create a background of the burdekin region for the inset map
dt_background <- n3_region |> 
  filter(Region == "Dry Tropics", Environment != "Marine") |> 
  group_by(Region) |> summarise(geom = st_union(geom))

#create a point of interest for townsville
tsv <- poi |> filter(PlaceName == "Townsville")

#create target vector to loop lover
target_vect <- unique(dt_region$BasinOrZone)

for (i in target_vect){
  
  #filter sites and rename column
  filtered_sites <- sites |> filter(BasinOrZone == i) |> rename("Sub Basin: Reported" = SubBasinOrSubZone)
  
  #define focus area and rename column
  focus_area <- dt_region |> filter(BasinOrZone == i) |> rename("Sub Basin: All" = SubBasinOrSubZone)
  
  #create the base water layer for the specific basin
  maps_water_layer(stream_order = c(2,9), water_lines = T, water_polygons = T, 
                   basin_or_zone = i, enviro = "Freshwater", fast = T)
  
  #create the background layer using the broader dry tropics backdrop
  maps_inset_layer(supplied_sf_1 = focus_area, background = dt_background, aspect = 1, use_bbox_1 = FALSE)

  #build on these two layers with customization
  map <- tm_shape(qld) +
    tm_polygons(fill = "grey80") +
    tm_shape(focus_area) +
    tm_polygons(fill = "grey90", 
                col = "grey90") +
    tm_shape(focus_area, is.main = T) +
    tm_polygons(fill = "Sub Basin: All", 
                fill_alpha = 0.5, 
                fill.scale = tm_scale_categorical(values = "brewer.pastel1"),
                col = "black") +
    water_map +
    tm_shape(tsv) +
    tm_symbols(size = 0.3, 
               fill = "white", 
               col = "black", 
               lwd = 1, 
               shape = 23) +
    tm_text("PlaceName", 
            size = 0.6,
            options = opt_tm_text(shadow = T, point.label = T)) +
    tm_shape(filtered_sites) +
    tm_symbols(size = 0.6, 
               fill = "Sub Basin: Reported", 
               fill.scale = tm_scale_categorical(values = "brewer.set1"),
               col = "black", 
               lwd = 2, 
               shape = 21) +
    tm_text("Code", 
            size= 0.9,
            options = opt_tm_text(shadow = T, point.label = T)) +
    tm_layout(legend.bg.color = "white", 
              legend.position = c("left", "bottom"),
              asp = 1)

  #save map
  tmap_save(map, glue("{output_path}/{i}_Freshwater.png"), insets_tm = inset_map, insets_vp = inset_viewport)
  
}

```

# Create De-identified Map

Below we will create the same maps, but now with sites de-identified.

```{r}
#| label: create deidentifed region maps

#create target vector to loop lover
target_vect <- unique(dt_region$BasinOrZone)

for (i in target_vect){
  
#filter sites and rename column
  filtered_sites <- sites |> filter(BasinOrZone == i) |> rename("Sub Basin: Reported" = SubBasinOrSubZone)
  
  #define focus area and rename column
  focus_area <- dt_region |> filter(BasinOrZone == i) |> rename("Sub Basin: All" = SubBasinOrSubZone)
  
  #create the base water layer for the specific basin
  maps_water_layer(stream_order = c(2,9), water_lines = T, water_polygons = T, 
                   basin_or_zone = i, enviro = "Freshwater", fast = T)
  
  #create the background layer using the broader dry tropics backdrop
  maps_inset_layer(supplied_sf_1 = focus_area, background = dt_background, aspect = 1, use_bbox_1 = FALSE)

  #build on these two layers with customization
  map <- tm_shape(qld) +
    tm_polygons(fill = "grey80") +
    tm_shape(focus_area) +
    tm_polygons(fill = "grey90", 
                col = "grey90") +
    tm_shape(focus_area, is.main = T) +
    tm_polygons(fill = "Sub Basin: All", 
                fill_alpha = 0.5, 
                fill.scale = tm_scale_categorical(values = "brewer.pastel1"),
                col = "black") +
    water_map +
    tm_shape(tsv) +
    tm_symbols(size = 0.3, 
               fill = "white", 
               col = "black", 
               lwd = 1, 
               shape = 23) +
    tm_text("PlaceName", 
            size = 0.6,
            options = opt_tm_text(shadow = T, point.label = T)) +
    tm_shape(filtered_sites) +
    tm_symbols(size = 0.6, 
               fill = "Sub Basin: Reported", 
               fill.scale = tm_scale_categorical(values = "brewer.set1"),
               col = "black", 
               lwd = 2, 
               shape = 21) +
    #tm_text("Code", #removed as these are the deidentified maps
    #        size = 0.9,
    #        options = opt_tm_text(shadow = T, point.label = T)) +
    tm_layout(legend.bg.color = "white", 
              legend.position = c("left", "bottom"),
              asp = 1)
  
  #save map
  tmap_save(map, glue("{output_path}/{i}_de-identified_Freshwater.png"), insets_tm = inset_map, insets_vp = inset_viewport)

}

```

