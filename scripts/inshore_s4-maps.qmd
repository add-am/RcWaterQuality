---
title: "Inshore Marine Water Quality Exploratory Data Analysis"
subtitle: "A Healthy Waters Partnership Analysis"
description: "Script 4 in a series of script designed to analyse, score, and present inshore marine water quality in the Dry Tropics region. The output of this is used in the Dry Tropics Technical Report."
author: "Adam Shand"
format: html
params:
  script_crs: "EPSG:7844"
  script_fyear: 2024 
---

# Introduction

The purpose of this script is to create maps identifying the sampling site locations for the inshore marine water quality index.

These maps are used in the body of the methods document, and in the appendix of the technical report.

# Script Set Up

This script requires multiple core spatial packages, each of which is loaded below. Key variables are also created.

```{r}
#| label: load packages

#use pacman function to load and install (if required) all other packages
pacman::p_load(tidyverse, glue, here, sf, tmap, janitor, readxl, grid, RColorBrewer)

#install/load the custom RcTools package
#pak::pak("add-am/RcTools")
library(RcTools)

params <- get_quarto_params()

#return each param as its own object
script_crs <- params$script_crs
script_fyear <- params$script_fyear

#load in the custom function used to create the read and write folders for the script
source("functions/setup_helper.R")

#get the required paths
paths <- setup_helper(script_fyear)
data_path <- paths[[1]]
output_path <- paths[[2]]

#turn off scientific notation
options(scipen = 999)

```

# Load Data

## Spatial Data

A custom function build (or reloads) the n3_region dataset.

``` {r}
#| label: Load data

#if the data is on file, load it, otherwise built it and save it for next time
if (file.exists(here("data/n3_region.gpkg"))){
  n3_region <- st_read(here("data/n3_region.gpkg"))
} else {
  n3_region <- build_n3_region()
  st_write(n3_region, here("data/n3_region.gpkg"))
}

```

```{r}
#| label: load in all data
#| output: false

#read in the northern three spatial files and reduce down to only the components we need
dt_marine <- n3_region |> 
  filter(Region == "Dry Tropics", Environment == "Marine", BasinOrZone != "Offshore") |> 
  mutate(WatercourseOrGeographicArea = case_when(
    WatercourseOrGeographicArea == "Open Coastal" ~ "H.Open Coastal",
    WatercourseOrGeographicArea == "Enclosed Coastal" ~ "H.Enclosed Coastal",
    TRUE ~ WatercourseOrGeographicArea))

#get land components to help with background
dt_land <- n3_region |> 
  filter(Region == "Dry Tropics", Environment != "Marine") |> 
  group_by(BasinOrZone) |> 
  summarise(geom = st_union(geom)) |> 
  ungroup() |> st_cast() |> st_make_valid()

#read in site coords and convert to a simple feature object
sites <- read_excel(path = glue("{data_path}/dt_wq_inshore_metadata.xlsx"), sheet = "Current_Sites") |> 
  select(BasinOrZone, SubBasinOrSubZone, WatercourseOrGeographicArea, Code, Lat, Long) |> 
  st_as_sf(coords = c("Long", "Lat"), crs = script_crs)

```

# Create Map

First we need to make sure that the colours for the background are correctly associated with each sub zone.

```{r}

colours_to_use <- list(c("#FBB4AE", "#B3CDE3", "#CCEBC5", "#DECBE4", "#FED9A6", "#FFFFCC"), #CB background
                       c("#FBB4AE", "#B3CDE3", "#CCEBC5", "#FED9A6", "#FFFFCC"), #CB sites
                       c("#B3CDE3", "#FFFFCC", "#DECBE4")) #HB background and sites

```

Now we can put everything together. We will loop over the Ross and Black to make individual maps.

```{r}
#| label: create region maps

#create target vector to loop lover
target_vect <- unique(dt_marine$BasinOrZone)

#create a similar vect for land basins
land_vect <- rev(unique(dt_land$BasinOrZone))

for (i in 1:length(target_vect)){
  
  #make a special colour counter that we can mess around with
  colour_counter <- i
  
  #filter sites and rename column
  filtered_sites <- sites |> 
    filter(BasinOrZone == target_vect[i]) |> 
    rename("Geographic Area: Reported" = WatercourseOrGeographicArea)
  
  #define focus area for waterways and rename column
  focus_area <- dt_land |> 
    filter(BasinOrZone == land_vect[i]) 
  
  #define focus area for marine wq sites and rename column
  focus_marine <- dt_marine |> 
    filter(BasinOrZone == target_vect[i]) |> 
    rename("Geographic Area: All" = WatercourseOrGeographicArea)

  #create the base water layer for the specific basin
  water_layer <- maps_water_layer(land_vect[i], WaterAreas = TRUE, WaterLakes = TRUE, StreamOrder = 2)

  #create the background layer using the broader dry tropics backdrop
  inset_objects <- maps_inset_layer(filtered_sites, focus_marine, 1.1)
  
  #adjust the colour call for the second loop
  if (colour_counter == 2) {colour_counter <- 3}
  
  #create the main map
  map <- tm_shape(qld) +
    tm_polygons(fill = "grey80", col = "black") +
    tm_shape(filtered_sites, is.main = TRUE) +
    tm_symbols(size = 0, fill_alpha = 0) +
    tm_shape(dt_marine) +
    tm_polygons(fill = "white", col = "black") +
    tm_shape(focus_marine) +
    tm_polygons(fill = "grey90", col = "grey90") +
    tm_shape(dt_land) +
    tm_polygons(fill = "grey90", col = "black") +
    tm_shape(focus_marine) +
    tm_polygons(
      fill = "Geographic Area: All", 
      fill.scale = tm_scale_categorical(values = colours_to_use[[colour_counter]]),
      fill_alpha = 0.7,
      col = "black") +
    water_layer
  
  #adjust the colour call for the first loop
  if (colour_counter == 1) {colour_counter <- 2}
  
  map <- map  +
    tm_shape(filtered_sites) +
    tm_symbols(
      size = 0.6, 
      fill = "Geographic Area: Reported",
      fill.scale = tm_scale_categorical(values = colours_to_use[[colour_counter]]),
      col = "black", 
      lwd = 2, 
      shape = 21) +
    tm_text(
      "Code",
      size = 0.9,
      options = opt_tm_text(shadow = TRUE, point.label = TRUE)) +
    tm_layout(
      legend.bg.color = "white", 
      legend.position = c("right", "bottom"),
      asp = 1.1)
    
  #save map
  tmap_save(
    map, 
    glue("{output_path}/{target_vect[i]}_Inshore.png"), 
    insets_tm = inset_objects[[1]], 
    insets_vp = inset_objects[[2]])
  
}

```

# Create De-identified Map

Below we will create the same maps, but now with sites de-identified.

```{r}
#| label: create deidentified region maps

for (i in 1:length(target_vect)){
  
  #make a special colour counter that we can mess around with
  colour_counter <- i
  
  #filter sites and rename column
  filtered_sites <- sites |> 
    filter(BasinOrZone == target_vect[i]) |> 
    rename("Geographic Area: Reported" = WatercourseOrGeographicArea)
  
  #define focus area for waterways and rename column
  focus_area <- dt_land |> 
    filter(BasinOrZone == land_vect[i]) 
  
  #define focus area for marine wq sites and rename column
  focus_marine <- dt_marine |> 
    filter(BasinOrZone == target_vect[i]) |> 
    rename("Geographic Area: All" = WatercourseOrGeographicArea)

  #create the base water layer for the specific basin
  water_layer <- maps_water_layer(land_vect[i], WaterAreas = TRUE, WaterLakes = TRUE, StreamOrder = 2)

  #create the background layer using the broader dry tropics backdrop
  inset_objects <- maps_inset_layer(filtered_sites, focus_marine, 1.1)
  
  #adjust the colour call for the second loop
  if (colour_counter == 2) {colour_counter <- 3}
  
  #create the main map
  map <- tm_shape(qld) +
    tm_polygons(fill = "grey80", col = "black") +
    tm_shape(filtered_sites, is.main = TRUE) +
    tm_symbols(size = 0, fill_alpha = 0) +
    tm_shape(dt_marine) +
    tm_polygons(fill = "white", col = "black") +
    tm_shape(focus_marine) +
    tm_polygons(fill = "grey90", col = "grey90") +
    tm_shape(dt_land) +
    tm_polygons(fill = "grey90", col = "black") +
    tm_shape(focus_marine) +
    tm_polygons(
      fill = "Geographic Area: All", 
      fill.scale = tm_scale_categorical(values = colours_to_use[[colour_counter]]),
      fill_alpha = 0.7,
      col = "black") +
    water_layer
  
  #adjust the colour call for the first loop
  if (colour_counter == 1) {colour_counter <- 2}
  
  map <- map  +
    tm_shape(filtered_sites) +
    tm_symbols(
      size = 0.6, 
      fill = "Geographic Area: Reported",
      fill.scale = tm_scale_categorical(values = colours_to_use[[colour_counter]]),
      col = "black", 
      lwd = 2, 
      shape = 21) +
    #tm_text(
    #  "Code",
    #  size = 0.9,
    #  options = opt_tm_text(shadow = TRUE, point.label = TRUE)) +
    tm_layout(
      legend.bg.color = "white", 
      legend.position = c("right", "bottom"),
      asp = 1.1)
    
  #save map
  tmap_save(
    map, 
    glue("{output_path}/{target_vect[i]}_Inshore.png"), 
    insets_tm = inset_objects[[1]], 
    insets_vp = inset_objects[[2]])
  
}

```

```{r}


```

